{"version":3,"sources":["popup.js"],"names":["SetupController","$scope","storage","$rootScope","defaults","server","type","get","then","data","angular","extend","$apply","e","error","message","saveSetup","form","setupForm","values","$invalid","forEach","$error","ctrl","$setViewValue","storageKeys","key","set","chrome","runtime","sendMessage","cmd","loading","scope","page","catch","onKeydown","keyCode","$valid","this","$on","e_","BugController","$timeout","loop","getBugList","getBugError","bugs","bugMap","newBugs","bug","exsits","ID","hasOwnProperty","push","filter","concat","length","setBugIndex","err","bugError","ignoreLocalFix","columns","openBug","id","openBugfree","reloadExtension","index","bugIndex","b","Error","isSpectialColumn","name","indexOf","toggleLocalFix","v","originalBugs","filteredBugs","isLocalFix","resetStorage","clear","onModuleRun","isSetuped","console","window","addEventListener","$broadcast","app","module","controller","run","factory","cache","keys","Promise","resolve","reject","local","valid","$inject"],"mappings":"CAAE,WACF,aAkEA,SAASA,EAAgBC,EAAQC,EAASC,GACzC,IAAIC,GACHC,OAAQ,qBACRC,KAAM,WAIPJ,EAAQK,MAAMC,KAAK,SAASC,GACxBA,GACFC,QAAQC,OAAOV,EAAQG,EAAUK,GAElCR,EAAOW,UACL,SAASC,GACXZ,EAAOa,MAAQD,EAAEE,QACjBd,EAAOW,WAGRX,EAAOe,UAAY,WAClB,IAAIC,EAAOhB,EAAOiB,UACdC,KACDF,EAAKG,SACPV,QAAQW,QAAQJ,EAAKK,OAAQ,SAASC,GACrCA,EAAKC,cAAc,OAIrBd,QAAQW,QAAQI,EAAa,SAASC,GACrCP,EAAOO,GAAOzB,EAAOyB,KAEtBP,EAAOd,OAAS,UAAYc,EAAOd,OAEnCH,EAAQyB,IAAIR,GAAQX,KAAK,WACxBoB,OAAOC,QAAQC,aAAaC,IAAK,cAAe,WAC/C9B,EAAO+B,SAAU,EACjB7B,EAAWS,OAAO,SAASqB,GAC1BA,EAAMC,KAAO,gBAGbC,MAAM,SAAStB,GACjBZ,EAAOW,OAAO,SAASqB,GACtBA,EAAMnB,MAAQD,EAAEE,YAGlBd,EAAO+B,SAAU,IAGlB/B,EAAOmC,UAAY,SAASvB,GACV,KAAdA,EAAEwB,SAAkBpC,EAAOiB,UAAUoB,QACvCC,KAAKvB,aAIPf,EAAOuC,IAAI,QAAS,SAASC,EAAI5B,GAChCZ,EAAOa,MAAQD,EAAEE,UAMnB,SAAS2B,EAAczC,EAAQ0C,EAAUzC,GA2ExC,SAAS0C,IACRC,IACAC,IACAH,EAASC,EAAM,KAGhB,SAASC,IACRjB,OAAOC,QAAQC,aAAaC,IAAK,gBAAiB,SAASgB,GAC1D,IAAIC,KACAC,KACJvC,QAAQW,QAAQpB,EAAO8C,KAAM,SAASG,GAErCA,EAAIC,QAAS,EACbH,EAAOE,EAAIE,IAAMF,IAElBxC,QAAQW,QAAQ0B,EAAM,SAASG,GAC3BF,EAAOK,eAAeH,EAAIE,KAC5BF,EAAIC,QAAS,EACbzC,QAAQC,OAAOqC,EAAOE,EAAIE,IAAKF,IAE/BD,EAAQK,KAAKJ,KAGfjD,EAAO8C,KAAO9C,EAAO8C,KAAKQ,OAAO,SAASL,GACzC,IAAIC,EAASD,EAAIC,OAEjB,cADOD,EAAIC,OACJA,IACLK,OAAOP,IAENhD,EAAOoD,eAAe,aAAepD,EAAO8C,KAAKU,OAAS,GAC7DxD,EAAOyD,YAAYzD,EAAO8C,KAAK,GAAGK,IAEnCnD,EAAOW,WAGT,SAASkC,IACRlB,OAAOC,QAAQC,aAAaC,IAAK,iBAAkB,SAAS4B,GAC3D1D,EAAO2D,SAAWD,EAClB1D,EAAOW,WAhHTX,EAAO4D,gBAAiB,EACxB5D,EAAO8C,QACP9C,EAAO6D,SACN,KAAM,QAAS,OAAQ,OAAQ,OAAQ,MACvC,MAAO,MAAO,MAAO,OAAQ,OAAQ,KAAM,QAK5C7D,EAAO8D,QAAU,SAASC,GACzBpC,OAAOC,QAAQC,aAAaC,IAAK,WAAYiC,GAAIA,KAGlD/D,EAAOgE,YAAc,WACpBrC,OAAOC,QAAQC,aAAaC,IAAK,kBAGlC9B,EAAOiE,gBAAkB,WACxBtC,OAAOC,QAAQC,aAAaC,IAAK,YAGlC9B,EAAOyD,YAAc,SAASS,GAC7B,IAAIjB,EACJjD,EAAOmE,SAAWD,EAClBlE,EAAO8C,KAAK1B,QAAQ,SAASgD,GACzBA,EAAEjB,KAAOe,IACXjB,EAAMmB,KAILnB,EAAIG,eAAe,SAGtBzB,OAAOC,QAAQC,aACdC,IAAK,aACLiC,GAAIG,GACF,SAAS1D,IACPA,GAAQA,aAAgB6D,QAG5B5D,QAAQC,OAAOuC,EAAKzC,GACpBR,EAAOW,aAITX,EAAOsE,iBAAmB,SAASC,GAClC,OAAQ,KAAM,KAAM,QAAQC,QAAQD,IAAS,GAG9CvE,EAAOyE,eAAiB,SAASC,GAChC,IAAI5B,EAAO9C,EAAO2E,cAAgB3E,EAAO8C,KACrC8B,EAAe9B,EAAKQ,OAAO,SAASL,GAEvC,MAD4B,cAAhBA,EAAI,UACCyB,IAElB1E,EAAO2E,aAAe7B,EACtB9C,EAAO8C,KAAO8B,EACX5E,EAAO2E,aAAanB,SAAWxD,EAAO8C,KAAKU,eACtCxD,EAAO2E,cAIhB3E,EAAO6E,WAAa,SAAS5B,GAC5B,MAAuB,cAAhBA,EAAI,SAGZjD,EAAO8E,aAAe,WACrB7E,EAAQ8E,QAAQxE,KAAK,WACpBoB,OAAOC,QAAQC,aAAaC,IAAK,cAInCa,IA+CD,SAASqC,EAAY9E,EAAYD,EAASgF,GAEzChF,EAAQK,MAAMC,KAAK,SAASC,GAC3BN,EAAWS,OAAO,SAASqB,GAC1BA,EAAMC,KAAOgD,EAAUzE,GAAQ,UAAY,YAE1C0B,MAAM,SAASwB,GACjBwB,QAAQrE,MAAM,mBAAoB6C,KAGnCyB,OAAOC,iBAAiB,QAAS,SAASxE,GACzCV,EAAWmF,WAAW,QAASzE,KA9PjC,IAAIY,GACH,SACA,OACA,WACA,YAEG8D,EAAM7E,QAAQ8E,OAAO,aAEzBD,EAAIE,WAAW,kBAAmBzF,GAElCuF,EAAIE,WAAW,gBAAiB/C,GAEhC6C,EAAIG,IAAIT,GAERM,EAAII,QAAQ,UAAW,WACtB,IAAIC,EACJ,OACCrF,IAKD,SAAoBsF,GACnB,OAAGD,EACKE,QAAQC,QAAQH,GAEjB,IAAIE,QAAQ,SAASC,EAASC,GACpCpE,OAAO1B,QAAQ+F,MAAM1F,IAAIsF,GAAQpE,EAAa,SAAShB,GACtDmF,EAAQnF,EACRA,EAAOsF,EAAQtF,GAAQuF,SAXzBrE,IAgBD,SAAoBlB,GACnB,OAAO,IAAIqF,QAAQ,SAASC,EAASC,GACpCJ,EAAQ,KACRhE,OAAO1B,QAAQ+F,MAAMtE,IAAIlB,EAAM,SAASI,GACvCA,EAAImF,EAAOnF,GAAKkF,SAnBlBf,MAwBD,WACC,OAAO,IAAIc,QAAQ,SAASC,EAASC,GACpCpE,OAAO1B,QAAQ+F,MAAMjB,MAAM,SAASrB,GACnCA,EAAMqC,EAAOrC,GAAOoC,YAMxBR,EAAII,QAAQ,YAAa,WACxB,OAAO,SAASlF,GACf,IAAIyF,GAAQ,EAMZ,OALAxF,QAAQW,QAAQI,EAAa,SAASC,GACjCjB,EAAK4C,eAAe3B,KACvBwE,GAAQ,KAGHA,KA6DTlG,EAAgBmG,SAAW,SAAU,UAAW,cAwHhDzD,EAAcyD,SAAW,SAAU,WAAY,WAiB/ClB,EAAYkB,SAAW,aAAc,UAAW","file":"../../src/js/popup.js","sourcesContent":[";(function() {\n\"use strict\";\n\nvar storageKeys = [\n\t\"server\",\n\t\"type\",\n\t\"username\",\n\t\"password\"\n];\nvar app = angular.module(\"BugApp\", []);\n\napp.controller(\"SetupController\", SetupController);\n\napp.controller(\"BugController\", BugController);\n\napp.run(onModuleRun);\n\napp.factory(\"storage\", function(){\n\tvar cache;\n\treturn {\n\t\tget: getStorage,\n\t\tset: setStorage,\n\t\tclear: clearStorage\n\t};\n\n\tfunction getStorage(keys){\n\t\tif(cache) {\n\t\t\treturn Promise.resolve(cache);\n\t\t}\n\t\treturn new Promise(function(resolve, reject){\n\t\t\tchrome.storage.local.get(keys || storageKeys, function(data){\n\t\t\t\tcache = data;\n\t\t\t\tdata ? resolve(data) : reject();\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction setStorage(data){\n\t\treturn new Promise(function(resolve, reject){\n\t\t\tcache = null;\n\t\t\tchrome.storage.local.set(data, function(e){\n\t\t\t\te ? reject(e) : resolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction clearStorage(){\n\t\treturn new Promise(function(resolve, reject){\n\t\t\tchrome.storage.local.clear(function(err){\n\t\t\t\terr ? reject(err) : resolve();\n\t\t\t});\n\t\t});\n\t}\n});\n\napp.factory(\"isSetuped\", function(){\n\treturn function(data){\n\t\tvar valid = true;\n\t\tangular.forEach(storageKeys, function(key){\n\t\t\tif(!data.hasOwnProperty(key)) {\n\t\t\t\tvalid = false;\n\t\t\t}\n\t\t});\n\t\treturn valid;\n\t};\n});\n\nfunction SetupController($scope, storage, $rootScope){\n\tvar defaults = {\n\t\tserver: \"172.16.203.11:8011\",\n\t\ttype: \"bugfree\"\n\t};\n\n\t// 异步操作，完成后刷新 scope\n\tstorage.get().then(function(data){\n\t\tif(data) {\n\t\t\tangular.extend($scope, defaults, data);\n\t\t}\n\t\t$scope.$apply();\n\t}, function(e){\n\t\t$scope.error = e.message;\n\t\t$scope.$apply();\n\t});\n\n\t$scope.saveSetup = function(){\n\t\tvar form = $scope.setupForm;\n\t\tvar values = {};\n\t\tif(form.$invalid) {\n\t\t\tangular.forEach(form.$error, function(ctrl){\n\t\t\t\tctrl.$setViewValue(\"\");\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tangular.forEach(storageKeys, function(key){\n\t\t\tvalues[key] = $scope[key];\n\t\t});\n\t\tvalues.server = \"http://\" + values.server;\n\t\t\n\t\tstorage.set(values).then(function(){\n\t\t\tchrome.runtime.sendMessage({cmd: \"test-ready\"}, function(){\n\t\t\t\t$scope.loading = false;\n\t\t\t\t$rootScope.$apply(function(scope){\n\t\t\t\t\tscope.page = \"buglist\";\n\t\t\t\t});\n\t\t\t});\n\t\t}).catch(function(e){\n\t\t\t$scope.$apply(function(scope){\n\t\t\t\tscope.error = e.message;\n\t\t\t});\n\t\t});\n\t\t$scope.loading = true;\n\t};\n\n\t$scope.onKeydown = function(e){\n\t\tif(e.keyCode === 13 && $scope.setupForm.$valid) {\n\t\t\tthis.saveSetup();\n\t\t}\n\t};\n\n\t$scope.$on(\"error\", function(e_, e){\n\t\t$scope.error = e.message\n\t});\n}\n\nSetupController.$inject = [\"$scope\", \"storage\", \"$rootScope\"];\n\nfunction BugController($scope, $timeout, storage){\n\t$scope.ignoreLocalFix = false;\n\t$scope.bugs = [];\n\t$scope.columns = [\n\t\t\"ID\", \"Bug标题\", \"修改日期\", \"模块路径\", \"严重程度\", \"优先级\",\n\t\t\"创建者\", \"指派者\", \"解决者\", \"解决方案\", \"处理状态\", \"附件\", \"复现步骤\"\n\t];\n\n\t\n\n\t$scope.openBug = function(id){\n\t\tchrome.runtime.sendMessage({cmd: \"open-bug\", id: id});\n\t};\n\n\t$scope.openBugfree = function(){\n\t\tchrome.runtime.sendMessage({cmd: \"open-bugfree\"});\n\t};\n\n\t$scope.reloadExtension = function(){\n\t\tchrome.runtime.sendMessage({cmd: \"reload\"});\n\t};\n\t\n\t$scope.setBugIndex = function(index){\n\t\tvar bug;\n\t\t$scope.bugIndex = index;\n\t\t$scope.bugs.forEach(function(b){\n\t\t\tif(b.ID === index) {\n\t\t\t\tbug = b;\n\t\t\t}\n\t\t});\n\t\t// 已经获取过详细信息了\n\t\tif(bug.hasOwnProperty(\"模块路径\")) {\n\t\t\treturn; \n\t\t}\n\t\tchrome.runtime.sendMessage({\n\t\t\tcmd: \"bug-detail\",\n\t\t\tid: index\n\t\t}, function(data){\n\t\t\tif(!data || data instanceof Error) {\n\t\t\t\treturn; \n\t\t\t}\n\t\t\tangular.extend(bug, data);\n\t\t\t$scope.$apply();\n\t\t});\n\t};\n\n\t$scope.isSpectialColumn = function(name){\n\t\treturn [\"ID\", \"附件\", \"复现步骤\"].indexOf(name) > -1;\n\t};\n\n\t$scope.toggleLocalFix = function(v){\n\t\tvar bugs = $scope.originalBugs || $scope.bugs;\n\t\tvar filteredBugs = bugs.filter(function(bug){\n\t\t\tvar isfix = bug[\"处理状态\"] === \"Local Fix\";\n\t\t\treturn isfix !== v;\n\t\t});\n\t\t$scope.originalBugs = bugs;\n\t\t$scope.bugs = filteredBugs;\n\t\tif($scope.originalBugs.length === $scope.bugs.length) {\n\t\t\tdelete $scope.originalBugs;\n\t\t}\n\t};\n\n\t$scope.isLocalFix = function(bug) {\n\t\treturn bug[\"处理状态\"] === \"Local Fix\";\n\t};\n\n\t$scope.resetStorage = function(){\n\t\tstorage.clear().then(function(){\n\t\t\tchrome.runtime.sendMessage({cmd: \"reload\"});\n\t\t});\n\t};\n\n\tloop();\n\n\tfunction loop() {\n\t\tgetBugList();\n\t\tgetBugError();\n\t\t$timeout(loop, 2000);\n\t}\n\n\tfunction getBugList(){\n\t\tchrome.runtime.sendMessage({cmd: \"get-bug-list\"}, function(bugs){\n\t\t\tvar bugMap = {};\n\t\t\tvar newBugs = [];\n\t\t\tangular.forEach($scope.bugs, function(bug){\n\t\t\t\t// 标记 bug 为不存在，合并新 bug 数据后删除此标记\n\t\t\t\tbug.exsits = false;\n\t\t\t\tbugMap[bug.ID] = bug;\n\t\t\t});\n\t\t\tangular.forEach(bugs, function(bug){\n\t\t\t\tif(bugMap.hasOwnProperty(bug.ID)) {\n\t\t\t\t\tbug.exsits = true;\n\t\t\t\t\tangular.extend(bugMap[bug.ID], bug);\n\t\t\t\t} else {\n\t\t\t\t\tnewBugs.push(bug);\n\t\t\t\t}\n\t\t\t});\n\t\t\t$scope.bugs = $scope.bugs.filter(function(bug){\n\t\t\t\tvar exsits = bug.exsits;\n\t\t\t\tdelete bug.exsits;\n\t\t\t\treturn exsits;\n\t\t\t}).concat(newBugs);\n\t\t\t// 自动显示第一个 bug\n\t\t\tif(!$scope.hasOwnProperty(\"bugIndex\") && $scope.bugs.length > 0) {\n\t\t\t\t$scope.setBugIndex($scope.bugs[0].ID);\n\t\t\t}\n\t\t\t$scope.$apply();\n\t\t});\n\t}\n\tfunction getBugError(){\n\t\tchrome.runtime.sendMessage({cmd: \"get-bug-error\"}, function(err){\n\t\t\t$scope.bugError = err;\n\t\t\t$scope.$apply();\n\t\t});\n\t}\n}\n\nBugController.$inject = [\"$scope\", \"$timeout\", \"storage\"];\n\nfunction onModuleRun($rootScope, storage, isSetuped){\n\t// 根据是否有存储的数据来判断显示哪个界面\n\tstorage.get().then(function(data){\n\t\t$rootScope.$apply(function(scope){\n\t\t\tscope.page = isSetuped(data) ? \"buglist\" : \"setup\";\n\t\t});\n\t}).catch(function(err){\n\t\tconsole.error(\"unexpected error\", err);\n\t});\n\t// 汇报页面报错信息\n\twindow.addEventListener(\"error\", function(e){\n\t\t$rootScope.$broadcast(\"error\", e);\n\t});\n}\n\nonModuleRun.$inject = [\"$rootScope\", \"storage\", \"isSetuped\"];\n}());\n"]}