{"version":3,"sources":["background.js"],"names":["main","getVariables","then","obj","server","username","password","bugServerOrigin","bugServerType","type","bugServerUsername","bugServerPassword","loginBugfree","loop","getBugs","bugs","updateBadgeText","updateBugCache","loopTimer","setTimeout","refreshBugInterval","catch","e","bugerror","message","errorCount","pluginReady","restartInterval","triggerReadyCallbacks","err","Error","console","error","getBugDetail","id","callback","url","bugDetailCache","hasOwnProperty","Promise","resolve","reject","ajax","data","xhr","responseType","doc","detail","Bug标题","querySelector","value","模块路径","复现步骤","innerText","trim","replace","imgs","querySelectorAll","map","call","a","getAttribute","text","visible","bugUrl","cells","rowObj","rows","firstElementChild","headCells","slice","i","len","length","forEach","cell","className","push","chrome","storage","local","get","storageKeys","loginUrl","formdata","FormData","append","badgeText","color","bugCount","notFixCount","filter","bug","browserAction","setBadgeText","setBadgeBackgroundColor","oldBugsMap","newBugs","buglist","ID","some","notifiedBugs","showBugNotification","showNotification","arr","pluginReadyCallbacks","shift","log","title","notifications","create","iconUrl","method","onResponse","XMLHttpRequest","open","addEventListener","target","response","arg","Object","prototype","toString","JSON","stringify","send","runtime","onMessage","addListener","msg","sender","cmd","tabs","reload","onChanged","changes","area","clearTimeout","onClicked","clear","bugId","split","pop"],"mappings":"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","file":"../../src/js/background.js","sourcesContent":[";(function() {\n\"use strict\";\n\nvar bugServerOrigin;\nvar bugServerType; // eslint-disable-line no-unused-vars\nvar bugServerUsername;\nvar bugServerPassword;\n\nvar pluginReady = false;\nvar pluginReadyCallbacks = [];\n\nvar restartInterval = 5 * 60 * 1000;    // 发生错误导致重启整个流程间隔\nvar refreshBugInterval = 3 * 60 * 1000; // bug 列表刷新间隔\n\nvar storageKeys = [\n\t\"server\",\n\t\"type\",\n\t\"username\",\n\t\"password\"\n];\n\nvar buglist = [];\nvar bugerror;\nvar loopTimer;\nvar bugDetailCache = {}; // 缓存 bug 详细信息\nvar notifiedBugs = {};   // 已经通知过的 bug \n\n// 接收来自 popup 的消息\nchrome.runtime.onMessage.addListener(function(msg, sender, callback){\n\tif(!pluginReady) {\n\t\treturn callback(new Error(\"plugin not ready now\"));\n\t}\n\tswitch(msg.cmd) {\n\t\tcase \"get-bug-list\":\n\t\t\tcallback(buglist ? buglist : []);\n\t\t\tbreak;\n\t\tcase \"get-bug-error\":\n\t\t\tcallback(bugerror || \"\");\n\t\t\tbreak;\n\t\tcase \"open-bug\":\n\t\t\tchrome.tabs.create({\n\t\t\t\turl: bugServerOrigin + \"/bugfree/index.php/bug/\" + msg.id\n\t\t\t});\n\t\t\tbreak;\n\t\tcase \"open-bugfree\":\n\t\t\tchrome.tabs.create({\n\t\t\t\t// eslint-disable-next-line max-len\n\t\t\t\turl: bugServerOrigin + \"/bugfree/index.php/bug/list/1?query_id=-2\"\n\t\t\t});\n\t\t\tbreak;\n\t\tcase \"bug-detail\":\n\t\t\tgetBugDetail(msg.id, callback);\n\t\t\treturn true;\n\t\tcase \"test-ready\":\n\t\t\tif(pluginReady) {\n\t\t\t\tcallback(true);\n\t\t\t} else {\n\t\t\t\tpluginReadyCallbacks.push(callback);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"reload\":\n\t\t\tchrome.runtime.reload();\n\t\t\tbreak;\n\t\tcase \"error\":\n\t\t\tconsole.error(\"error from popup:\");\n\t\t\tconsole.error(msg.error);\n\t\t\tbreak;\n\t}\n});\n\n// 监听 storage\nchrome.storage.onChanged.addListener(function(changes, area){\n\tif(area !== \"local\") {\n\t\treturn; \n\t}\n\tclearTimeout(loopTimer);\n\tmain();\n});\n\n// 监听通知点击\nchrome.notifications.onClicked.addListener(function(id){\n\t// clear first\n\tchrome.notifications.clear(id);\n\tvar bugId = id.split(\"-\").pop();\n\tvar bug = buglist.filter(function(bug){\n\t\treturn bug.ID === bugId;\n\t})[0];\n\tif(!bug) {\n\t\treturn; \n\t}\n\tchrome.tabs.create({\n\t\turl: bugServerOrigin + \"/bugfree/index.php/bug/\" + bug.ID\n\t});\n});\n\nmain();\n\n\nfunction main(){\n\tgetVariables().then(function(obj){\n\t\tif(obj.server && obj.username && obj.password) {\n\t\t\treturn obj;\n\t\t} else {\n\t\t\tthrow \"no user registered!\";\n\t\t}\n\t}).then(function(obj){\n\t\tbugServerOrigin = obj.server;\n\t\tbugServerType = obj.type;\n\t\tbugServerUsername = obj.username;\n\t\tbugServerPassword = obj.password;\n\t\treturn loginBugfree();\n\t}).then(function(){\n\t\tvar errorCount = 0; // 错误\n\t\tpluginReady = true;\n\t\tbugerror = \"\";\n\t\ttriggerReadyCallbacks();\n\t\tloop();\n\t\tfunction loop(){\n\t\t\tgetBugs().then(function(bugs){\n\t\t\t\tbugs = updateBugCache(bugs);\n\t\t\t\tupdateBadgeText(bugs);\n\t\t\t\tloopTimer = setTimeout(loop, refreshBugInterval);\n\t\t\t}).catch(function(e){\n\t\t\t\tbugerror = e.message;\n\t\t\t\tupdateBadgeText(e);\n\t\t\t\terrorCount++;\n\t\t\t\t// 连续两次无法获取bug信息，清空 bug 列表，并从头开始运行\n\t\t\t\tif(errorCount >= 2) {\n\t\t\t\t\tpluginReady = false;\n\t\t\t\t\tupdateBugCache([]);\n\t\t\t\t\tloopTimer = setTimeout(main, restartInterval);\n\t\t\t\t} else {\n\t\t\t\t\tloopTimer = setTimeout(loop, refreshBugInterval);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}).catch(function(err){\n\t\tif(err instanceof Error) {\n\t\t\tbugerror = err.message;\n\t\t\tconsole.error(err.message);\n\t\t}\n\t\t// 任何报错后，5分钟后重试\n\t\tloopTimer = setTimeout(main, restartInterval);\n\t});\n}\n\nfunction getBugDetail(id, callback){\n\tvar url = bugServerOrigin + \"/bugfree/index.php/bug/\" + id;\n\tif(bugDetailCache.hasOwnProperty(url)) {\n\t\treturn Promise.resolve(bugDetailCache[url]);\n\t}\n\treturn (new Promise(function(resolve, reject){\n\t\tajax(\"GET\", url, function(err, data){\n\t\t\tif(err) {\n\t\t\t\treject(err);\n\t\t\t} else {\n\t\t\t\tresolve(data);\n\t\t\t}\n\t\t})(function(xhr){\n\t\t\txhr.responseType = \"document\";\n\t\t});\n\t})).then(function(doc){\n\t\tvar detail = {\n\t\t\t\"Bug标题\": doc.querySelector(\"#BugInfoView_title\").value,\n\t\t\t\"模块路径\": doc.querySelector(\"#BugInfoView_module_name\").value,\n\t\t\t// eslint-disable-next-line max-len\n\t\t\t\"复现步骤\": doc.querySelector(\"#fieldset_step .row\").innerText.trim().replace(/\\n{2,}/g, \"\\n\")\n\t\t};\n\t\tvar imgs = doc.querySelectorAll(\"#uploaded_file a\");\n\t\timgs = [].map.call(imgs, function(a){\n\t\t\treturn {\n\t\t\t\turl: bugServerOrigin + a.getAttribute(\"href\"),\n\t\t\t\ttext: a.innerText,\n\t\t\t\tvisible: false\n\t\t\t};\n\t\t});\n\t\tdetail[\"附件\"] = imgs;\n\t\tbugDetailCache[url] = detail;\n\t\tcallback(detail);\n\t\treturn detail;\n\t});\n}\n\nfunction getBugs(){\n\tvar bugUrl = bugServerOrigin + \"/bugfree/index.php/bug/list/1?query_id=-2\";\n\treturn (new Promise(function(resolve, reject){\n\t\tajax(\"GET\", bugUrl, function(err, data){\n\t\t\tif(err) {\n\t\t\t\treject(err);\n\t\t\t} else {\n\t\t\t\tresolve(data);\n\t\t\t}\n\t\t})(function(xhr){\n\t\t\t// 指定返回为 document，避免手动解析\n\t\t\txhr.responseType = \"document\";\n\t\t});\n\t})).then(function(doc){\n\t\tvar result = doc.querySelector(\"#SearchResultDiv\");\n\t\tvar rows = result.firstElementChild.rows;\n\t\tvar bugs = [];\n\t\tvar headCells = [].slice.call(rows[0].cells, 0);\n\t\tvar cells, rowObj;\n\t\tfor(var i = 1, len = rows.length; i < len; i++) {\n\t\t\tcells = rows[i].cells;\n\t\t\trowObj = {};\n\t\t\theadCells.forEach(function(cell, i){\n\t\t\t\tif(!cells[i]) {\n\t\t\t\t\treturn; \n\t\t\t\t}\n\t\t\t\tif(cells[i].className === \"title\") {\n\t\t\t\t\t// eslint-disable-next-line max-len\n\t\t\t\t\trowObj[cell.innerText] = cells[i].querySelector(\"a\").getAttribute(\"title\");\n\t\t\t\t} else {\n\t\t\t\t\trowObj[cell.innerText] = cells[i].innerText;\n\t\t\t\t}\n\t\t\t});\n\t\t\tif(rowObj.hasOwnProperty(\"ID\")) {\n\t\t\t\tbugs.push(rowObj);\n\t\t\t}\n\t\t}\n\t\treturn bugs;\n\t});\n}\n\nfunction getVariables() {\n\treturn new Promise(function(resolve, reject){\n\t\tchrome.storage.local.get(storageKeys, function(obj){\n\t\t\tobj ? resolve(obj) : reject();\n\t\t});\n\t});\n}\n\nfunction loginBugfree(){\n\tvar loginUrl = bugServerOrigin + \"/bugfree/index.php/site/login\";\n\tvar formdata = new FormData();\n\tformdata.append(\"LoginForm[username]\", bugServerUsername);\n\tformdata.append(\"LoginForm[password]\", bugServerPassword);\n\tformdata.append(\"LoginForm[language]\", \"zh_cn\");\n\treturn new Promise(function(resolve, reject){\n\t\tajax(\"POST\", loginUrl, function(err, data){\n\t\t\tif(err) {\n\t\t\t\treject(err);\n\t\t\t} else {\n\t\t\t\tresolve(data);\n\t\t\t}\n\t\t})(formdata);\n\t});\n}\n\nfunction updateBadgeText(bugs) {\n\tvar badgeText;\n\tvar color;\n\tif(bugs instanceof Error) { // 插件报错了，标红\n\t\tbadgeText = \"err\";\n\t\tcolor = \"#e91e63\";\n\t} else {\n\t\tvar bugCount = bugs.length;\n\t\tvar notFixCount = bugs.filter(function(bug){\n\t\t\treturn bug[\"处理状态\"] !== \"Local Fix\";\n\t\t}).length;\n\t\t// 所有的 bug 都修复了\n\t\tif(notFixCount === 0) {\n\t\t\t// 当前没有 bug，透明\n\t\t\tif(bugCount === 0) {\n\t\t\t\tbadgeText = \"\";\n\t\t\t\tcolor = [0, 0, 0, 0];\n\t\t\t} else {\n\t\t\t\t// 有 bug，但是都修复了，标绿\n\t\t\t\tbadgeText = bugCount + \"\";\n\t\t\t\tcolor = \"#8bc34a\";\n\t\t\t}\n\t\t} else { // 有未修复的 bug，标红\n\t\t\tbadgeText = notFixCount + \"\";\n\t\t\tcolor = \"#e91e63\";\n\t\t}\n\t}\n\tchrome.browserAction.setBadgeText({text: badgeText});\n\tchrome.browserAction.setBadgeBackgroundColor({color: color});\n}\n\nfunction updateBugCache(bugs) {\n\tbugs = bugs.filter(function(bug){\n\t\treturn bug[\"解决方案\"] === \"\";\n\t});\n\tvar oldBugsMap = {};\n\tvar newBugs = []; // 相对于上一次来说，新增加的 bug\n\tbuglist.forEach(function(bug){\n\t\toldBugsMap[bug.ID] = bug;\n\t});\n\tbugs.forEach(function(bug){\n\t\tif(!oldBugsMap.hasOwnProperty(bug.ID)) {\n\t\t\tnewBugs.push(bug);\n\t\t}\n\t});\n\tvar hasStatusField = newBugs.length > 0 ? newBugs.some(function(bug){\n\t\treturn bug.hasOwnProperty(\"处理状态\");\n\t}) : true;\n\tif(hasStatusField) {\n\t\tnewBugs.forEach(function(bug){\n\t\t\t// `处理状态`为空时表示还没有处理过此 bug，其它状态忽略\n\t\t\t// 已经通知过的 bug 不再重复提示\n\t\t\tif(!bug[\"处理状态\"] && !notifiedBugs.hasOwnProperty(bug.ID)) {\n\t\t\t\tshowBugNotification(bug);\n\t\t\t\tnotifiedBugs[bug.ID] = true;\n\t\t\t}\n\t\t});\n\t} else {\n\t\tshowNotification(\n\t\t\t\"showbugs-ignore\",\n\t\t\t\"无法获取 bug 的\\\"处理状态\\\"列信息\",\n\t\t\t\"请在 bugfree 中添加此列，没有此列，插件不能及时向你通知新 bug\"\n\t\t);\n\t}\n\tbuglist = bugs;\n\treturn bugs;\n}\n\nfunction triggerReadyCallbacks(){\n\tvar arr = pluginReadyCallbacks;\n\tvar fn;\n\twhile(arr.length > 0) {\n\t\ttry {\n\t\t\tfn = arr.shift();\n\t\t\tfn();\n\t\t} catch(e) {\n\t\t\tconsole.log(\"ready callback error:\", e);\n\t\t}\n\t}\n}\n\nfunction showBugNotification(bug){\n\tshowNotification(\"showbugs-\" + bug.ID, \"亲，你有新 bug 啦！\", bug[\"Bug标题\"]);\n}\n\nfunction showNotification(id, title, message){\n\tchrome.notifications.create(id, {\n\t\ttype: \"basic\",\n\t\ticonUrl: \"../img/logo.png\",\n\t\ttitle: title,\n\t\tmessage: message\n\t});\n}\n\nfunction ajax(method, url, onResponse) {\n\tvar xhr = new XMLHttpRequest();\n\txhr.open(method, url);\n\tif(typeof onResponse === \"function\") {\n\t\txhr.addEventListener(\"load\", function(e){\n\t\t\tonResponse(null, e.target.response);\n\t\t});\n\t\txhr.addEventListener(\"error\", function(){\n\t\t\tonResponse(new Error(\"network error\"));\n\t\t});\n\t\txhr.addEventListener(\"timeout\", function(){\n\t\t\tonResponse(new Error(\"timeout\"));\n\t\t});\n\t}\n\treturn function(arg){\n\t\tvar data = null;\n\t\tvar type = Object.prototype.toString.call(arg);\n\t\ttype = type.replace(\"[object \", \"\").replace(\"]\", \"\");\n\t\t/* eslint-disable max-len */\n\t\tswitch(type) {\n\t\t\t// 这些类型的数据是可以直接发送的\n\t\t\t// 参考：https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send\n\t\t\tcase \"String\":\n\t\t\tcase \"FormData\":\n\t\t\tcase \"Blob\":\n\t\t\tcase \"ArrayBuffer\":\n\t\t\tcase \"Uint8Array\":\n\t\t\tcase \"Uint8ClampedArray\":\n\t\t\tcase \"Int16Array\":\n\t\t\tcase \"Uint16Array\":\n\t\t\tcase \"Int32Array\":\n\t\t\tcase \"Uint32Array\":\n\t\t\tcase \"Float32Array\":\n\t\t\tcase \"Float64Array\":\n\t\t\tcase \"DataView\":\n\t\t\tcase \"URLSearchParams\":\n\t\t\t\tdata = arg;\n\t\t\t\tbreak;\n\t\t\tcase \"Object\":\n\t\t\tcase \"Array\":\n\t\t\t\tdata = JSON.stringify(arg);\n\t\t\t\tbreak;\n\t\t\t// 允许接收一个 function, 自定义操作\n\t\t\tcase \"Function\":\n\t\t\t\targ.call(xhr, xhr);\n\t\t\t\tbreak;\n\t\t}\n\t\txhr.send(data ? data : null);\n\t};\n}\n}());\n"]}