!function(){var e=["server","type","username","password"],n=angular.module("BugApp",[]);n.controller("SetupController",["$scope","storage","$rootScope",function(n,r,t){var o={server:"172.16.203.11:8011",type:"bugfree"};r.get().then(function(e){e&&angular.extend(n,o,e),n.$digest()},function(e){n.error=e.message,n.$digest()}),n.saveSetup=function(){var o=n.setupForm,u={};o.$invalid?angular.forEach(o.$error,function(e){e.$setViewValue("")}):(angular.forEach(e,function(e){u[e]=n[e]}),u.server="http://"+u.server,r.set(u).then(function(){t.$apply('page = "buglist"'),chrome.runtime.sendMessage({cmd:"reload"})},function(e){n.$apply("error = e.message")}))},n.$on("error",function(e,r){n.error=r.message})}]),n.controller("BugController",["$scope","$interval","storage",function(e,n,r){e.ignoreLocalFix=!1,e.bugs=[],e.columns=["ID","Bug标题","修改日期","模块路径","严重程度","优先级","创建者","指派者","解决者","解决方案","处理状态","附件","复现步骤"],chrome.runtime.sendMessage({cmd:"get-bug-list"},function(n){if(e.bugs=n,e.hasOwnProperty("bugIndex")){var r=!1;n.forEach(function(n){n.ID===e.bugIndex&&(r=!0)}),!r&&n.length>0&&e.setBugIndex(n[0].ID)}else n.length>0&&e.setBugIndex(n[0].ID);e.$digest()}),chrome.runtime.sendMessage({cmd:"get-bug-error"},function(n){e.bugError=n,e.$digest()}),e.openBug=function(e){chrome.runtime.sendMessage({cmd:"open-bug",id:e})},e.openBugfree=function(){chrome.runtime.sendMessage({cmd:"open-bugfree"})},e.setBugIndex=function(n){var t;e.bugIndex=n,e.bugs.forEach(function(e){e.ID===n&&(t=e)}),t.hasOwnProperty("模块路径")||chrome.runtime.sendMessage({cmd:"bug-detail",id:n},function(n){if(n){var o=(new DOMParser).parseFromString(n,"text/html");angular.extend(t,{"Bug标题":o.querySelector("#BugInfoView_title").value,"模块路径":o.querySelector("#BugInfoView_module_name").value,"复现步骤":o.querySelector("#fieldset_step .row").innerText.trim().replace(/\n{2,}/g,"\n")});var u=o.querySelectorAll("#uploaded_file a");u=[].map.call(u,function(e){return{url:e.getAttribute("href"),text:e.innerText,visible:!1}}),r.get().then(function(n){u.forEach(function(e){e.url=n.server+e.url}),t["附件"]=u,e.$digest()})}})},e.isSpectialColumn=function(e){return["ID","附件","复现步骤"].indexOf(e)>-1},e.toggleLocalFix=function(n){var r=e.originalBugs||e.bugs,t=r.filter(function(e){return"Local Fix"===e["处理状态"]!==n});e.originalBugs=r,e.bugs=t,e.originalBugs.length===e.bugs.length&&delete e.originalBugs},e.isLocalFix=function(e){return"Local Fix"===e["处理状态"]},e.resetStorage=function(){r.clear().then(function(){chrome.runtime.sendMessage({cmd:"reload"})})},e.$on("$destroy",function(){n.cancel(timer)})}]),n.run(["$rootScope","storage","isSetuped",function(e,n,r){n.get().then(function(n){r(n)?e.$apply("page = 'buglist'"):e.$apply("page = 'setup'")},function(n){$scope.error=n.message,e.$digest()}),window.addEventListener("error",function(n){e.$broadcast("error",n)})}]),n.factory("storage",function(){var n;return{get:function(r){return n?Promise.resolve(n):new Promise(function(t,o){chrome.storage.local.get(r||e,function(e){n=e,e?t(e):o()})})},set:function(e){return new Promise(function(r,t){n=null,chrome.storage.local.set(e,function(e){e?t(e):r()})})},clear:function(){return new Promise(function(e,n){chrome.storage.local.clear(function(r){r?n(r):e()})})}}}),n.factory("isSetuped",function(){return function(n){var r=!0;return angular.forEach(e,function(e){n.hasOwnProperty(e)||(r=!1)}),r}})}();