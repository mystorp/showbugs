!function(){function e(){t().then(function(e){if(e.server&&e.username&&e.password)return e;throw"no user registered!"}).then(function(e){return s=e.server,l=e.type,f=e.username,g=e.password,o()}).then(function(){function r(){n().then(function(e){a(e=c(e)),p=setTimeout(r,b)}).catch(function(r){d=r.message,a(r),++t>=2&&(m=!1,c([]),p=setTimeout(e,h))})}var t=0;m=!0,d="",r()}).catch(function(r){r instanceof Error&&(d=r.message,console.error(r.message)),p=setTimeout(e,h)})}function r(e,r){var n=s+"/bugfree/index.php/bug/"+e;return v.hasOwnProperty(n)?Promise.resolve(v[n]):new Promise(function(e,t){u("GET",n,function(e,t){v[n]=t,r(e||t)})(function(e){e.responseType="document"})}).then(function(e){var r={"Bug标题":e.querySelector("#BugInfoView_title").value,"模块路径":e.querySelector("#BugInfoView_module_name").value,"复现步骤":e.querySelector("#fieldset_step .row").innerText.trim().replace(/\n{2,}/g,"\n")},n=e.querySelectorAll("#uploaded_file a");return n=[].map.call(n,function(e){return{url:s+e.getAttribute("href"),text:e.innerText,visible:!1}}),r["附件"]=n,r})}function n(){var e=s+"/bugfree/index.php/bug/list/1?query_id=-2";return new Promise(function(r,n){u("GET",e,function(e,t){e?n(e):r(t)})(function(e){e.responseType="document"})}).then(function(e){for(var r,n,t=e.querySelector("#SearchResultDiv").firstElementChild.rows,o=[],a=[].slice.call(t[0].cells,0),c=1,i=t.length;c<i;c++)r=t[c].cells,n={},a.forEach(function(e,t){r[t]&&("title"===r[t].className?n[e.innerText]=r[t].querySelector("a").getAttribute("title"):n[e.innerText]=r[t].innerText)}),n.hasOwnProperty("ID")&&o.push(n);return o})}function t(){return new Promise(function(e,r){chrome.storage.local.get(w,function(n){n?e(n):r()})})}function o(){var e=s+"/bugfree/index.php/site/login",r=new FormData;return r.append("LoginForm[username]",f),r.append("LoginForm[password]",g),r.append("LoginForm[language]","zh_cn"),new Promise(function(n,t){u("POST",e,function(e,r){e?t(e):n(r)})(r)})}function a(e){if(e instanceof Error)chrome.browserAction.setBadgeText({text:"err"}),chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,255]});else{var r,n=e.length,t=e.filter(function(e){return"Local Fix"!==e["处理状态"]}).length;0===t?0===n?(r="",chrome.browserAction.setBadgeBackgroundColor({color:[0,0,0,0]})):(r=n+"",chrome.browserAction.setBadgeBackgroundColor({color:"#8bc34a"})):(r=t+"",chrome.browserAction.setBadgeBackgroundColor({color:"#e91e63"})),chrome.browserAction.setBadgeText({text:r})}}function c(e){var e=e.filter(function(e){return""===e["解决方案"]}),r={},n=[];return y.forEach(function(e){r[e.ID]=e}),e.forEach(function(e){r.hasOwnProperty(e.ID)||n.push(e)}),n.forEach(function(e){"Local Fix"!==e["处理状态"]&&i(e)}),y=e,e}function i(e){chrome.notifications.create("showbugs-"+e.ID,{type:"basic",iconUrl:"../img/logo.png",title:"亲，你有新 bug 啦！",message:e["Bug标题"]}),notificationBug=e}function u(e,r,n){var t=new XMLHttpRequest;return t.open(e,r),"function"==typeof n&&(t.addEventListener("load",function(e){n(null,e.target.response)}),t.addEventListener("error",n),t.addEventListener("timeout",n)),function(e){var r=null,n=Object.prototype.toString.call(e);switch(n=n.replace("[object ","").replace("]","")){case"String":case"FormData":case"Blob":case"ArrayBuffer":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"DataView":case"URLSearchParams":r=e;break;case"Object":case"Array":r=JSON.stringify(e);break;case"Function":e.call(t,t)}t.send(r||null)}}var s,l,f,g,d,p,m=!1,h=3e5,b=18e4,w=["server","type","username","password"],y=[];chrome.runtime.onMessage.addListener(function(e,n,t){if(!m)return t(new Error("plugin not ready now"));switch(e.cmd){case"get-bug-list":t(y||[]);break;case"get-bug-error":t(d||"");break;case"open-bug":chrome.tabs.create({url:s+"/bugfree/index.php/bug/"+e.id});break;case"open-bugfree":chrome.tabs.create({url:s+"/bugfree/index.php/bug/list/1?query_id=-2"});break;case"bug-detail":return r(e.id,t),!0;case"reload":chrome.runtime.reload();break;case"error":console.error("error from popup:"),console.error(e.error)}}),chrome.storage.onChanged.addListener(function(r,n){"local"===n&&(clearTimeout(p),e())}),chrome.notifications.onClicked.addListener(function(e){var r=e.split("-").pop();y.filter(function(e){return e.ID===r})[0]&&chrome.tabs.create({url:s+"/bugfree/index.php/bug/"+notificationBug.ID})}),e();var v={}}();